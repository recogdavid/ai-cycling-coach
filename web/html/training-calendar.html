<!-- training-calendar.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Training Calendar - AI Cycling Coach</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f7fa; color: #333; line-height: 1.6; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2rem; border-radius: 10px; margin-bottom: 2rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h1 { font-size: 2.5rem; margin-bottom: 0.5rem; }
        .subtitle { font-size: 1.1rem; opacity: 0.9; }
        .calendar-controls { display: flex; justify-content: space-between; align-items: center; background: white; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .month-nav { display: flex; gap: 1rem; align-items: center; }
        .btn { padding: 0.5rem 1rem; border: none; border-radius: 6px; background: #667eea; color: white; cursor: pointer; font-weight: 500; transition: all 0.2s; }
        .btn:hover { background: #5a67d8; transform: translateY(-1px); }
        .btn-secondary { background: #e2e8f0; color: #4a5568; }
        .btn-secondary:hover { background: #cbd5e0; }
        .current-month { font-size: 1.5rem; font-weight: 600; color: #2d3748; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: #e2e8f0; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .day-header { background: #4a5568; color: white; padding: 1rem; text-align: center; font-weight: 600; text-transform: uppercase; font-size: 0.9rem; letter-spacing: 1px; }
        .day-cell { background: white; min-height: 120px; padding: 0.5rem; position: relative; transition: all 0.2s; }
        .day-cell:hover { background: #f7fafc; transform: translateY(-2px); z-index: 1; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .day-number { font-size: 0.9rem; color: #718096; margin-bottom: 0.5rem; }
        .workout-card { background: #edf2f7; border-radius: 6px; padding: 0.5rem; margin-bottom: 0.5rem; border-left: 4px solid; cursor: pointer; transition: all 0.2s; }
        .workout-card:hover { background: #e2e8f0; transform: translateX(2px); }
        .workout-threshold { border-left-color: #f56565; }
        .workout-endurance { border-left-color: #48bb78; }
        .workout-recovery { border-left-color: #4299e1; }
        .workout-vo2_max { border-left-color: #ed8936; }
        .workout-type { font-size: 0.8rem; font-weight: 600; text-transform: uppercase; color: #4a5568; }
        .workout-duration { font-size: 0.8rem; color: #718096; }
        .workout-tss { font-size: 0.8rem; color: #667eea; font-weight: 600; }
        .status-badge { position: absolute; top: 0.5rem; right: 0.5rem; font-size: 0.7rem; padding: 0.2rem 0.5rem; border-radius: 12px; font-weight: 600; }
        .status-completed { background: #c6f6d5; color: #22543d; }
        .status-scheduled { background: #bee3f8; color: #2c5282; }
        .status-skipped { background: #fed7d7; color: #742a2a; }
        .loading { text-align: center; padding: 2rem; color: #718096; }
        .error { background: #fed7d7; color: #742a2a; padding: 1rem; border-radius: 6px; margin: 1rem 0; }
        .day-detail-panel { position: fixed; top: 0; right: 0; width: 400px; height: 100vh; background: white; box-shadow: -4px 0 20px rgba(0,0,0,0.1); padding: 2rem; overflow-y: auto; transform: translateX(100%); transition: transform 0.3s ease; z-index: 1000; }
        .day-detail-panel.open { transform: translateX(0); }
        .close-panel { position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #718096; }
        .workout-detail { background: #f7fafc; padding: 1rem; border-radius: 8px; margin: 1rem 0; }
        .file-downloads { display: flex; gap: 0.5rem; margin: 1rem 0; }
        .feedback-section { margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #e2e8f0; }
        .rpe-slider { width: 100%; margin: 1rem 0; }
        .rpe-labels { display: flex; justify-content: space-between; font-size: 0.9rem; color: #718096; }
        @media (max-width: 768px) {
            .calendar-grid { grid-template-columns: 1fr; }
            .day-header { display: none; }
            .day-detail-panel { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Training Calendar</h1>
            <p class="subtitle">AI-powered workout scheduling and tracking</p>
        </header>
        
        <div class="calendar-controls">
            <div class="month-nav">
                <button class="btn btn-secondary" onclick="previousMonth()">← Previous</button>
                <h2 class="current-month" id="current-month">December 2024</h2>
                <button class="btn btn-secondary" onclick="nextMonth()">Next →</button>
            </div>
            <div>
                <button class="btn" onclick="refreshCalendar()">Refresh</button>
                <button class="btn btn-secondary" onclick="showToday()">Today</button>
            </div>
        </div>
        
        <div class="calendar-grid" id="calendar-grid">
            <div class="loading" id="loading">Loading calendar...</div>
        </div>
        
        <div class="day-detail-panel" id="day-detail-panel">
            <button class="close-panel" onclick="closeDetailPanel()">×</button>
            <div id="day-detail-content"></div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE = "https://dabosch.fit/athlete-api";
        const ATHLETE_ID = 6;
        let currentDate = new Date();
        let currentYear = currentDate.getFullYear();
        let currentMonth = currentDate.getMonth() + 1;

        // DOM Elements
        const calendarGrid = document.getElementById('calendar-grid');
        const currentMonthEl = document.getElementById('current-month');
        const dayDetailPanel = document.getElementById('day-detail-panel');
        const dayDetailContent = document.getElementById('day-detail-content');

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadCalendar(currentYear, currentMonth);
        });

        // Load calendar for specific month
        async function loadCalendar(year, month) {
            try {
                showLoading();
                currentMonthEl.textContent = `${getMonthName(month)} ${year}`;
                
                const response = await fetch(`${API_BASE}/api/v1/calendar/${ATHLETE_ID}/${year}/${month}`);
                const data = await response.json();
                
                if (data.success) {
                    renderCalendar(data.days, year, month);
                } else {
                    showError('Failed to load calendar data');
                }
            } catch (error) {
                showError(`Error: ${error.message}`);
            }
        }

        // Render calendar grid
        function renderCalendar(days, year, month) {
            calendarGrid.innerHTML = '';
            
            // Add day headers
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayNames.forEach(day => {
                const header = document.createElement('div');
                header.className = 'day-header';
                header.textContent = day;
                calendarGrid.appendChild(header);
            });
            
            // Create date object for first day of month
            const firstDay = new Date(year, month - 1, 1);
            const startingDay = firstDay.getDay();
            
            // Add empty cells for days before first day of month
            for (let i = 0; i < startingDay; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'day-cell empty';
                calendarGrid.appendChild(emptyCell);
            }
            
            // Get days in month
            const daysInMonth = new Date(year, month, 0).getDate();
            
            // Create day cells
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
                const dayData = days.find(d => d.scheduled_date === dateStr);
                
                const dayCell = document.createElement('div');
                dayCell.className = 'day-cell';
                dayCell.onclick = () => openDayDetail(dateStr, dayData);
                
                // Day number
                const dayNumber = document.createElement('div');
                dayNumber.className = 'day-number';
                dayNumber.textContent = day;
                dayCell.appendChild(dayNumber);
                
                // Add workout if exists
                if (dayData && dayData.workout_type) {
                    const workoutCard = document.createElement('div');
                    workoutCard.className = `workout-card workout-${dayData.workout_type}`;
                    
                    const workoutType = document.createElement('div');
                    workoutType.className = 'workout-type';
                    workoutType.textContent = dayData.workout_type.replace('_', ' ');
                    workoutCard.appendChild(workoutType);
                    
                    if (dayData.duration_minutes) {
                        const duration = document.createElement('div');
                        duration.className = 'workout-duration';
                        duration.textContent = `${dayData.duration_minutes} min`;
                        workoutCard.appendChild(duration);
                    }
                    
                    if (dayData.target_tss) {
                        const tss = document.createElement('div');
                        tss.className = 'workout-tss';
                        tss.textContent = `TSS: ${dayData.target_tss}`;
                        workoutCard.appendChild(tss);
                    }
                    
                    dayCell.appendChild(workoutCard);
                    
                    // Status badge
                    if (dayData.completion_status) {
                        const statusBadge = document.createElement('div');
                        statusBadge.className = `status-badge status-${dayData.completion_status}`;
                        statusBadge.textContent = dayData.completion_status;
                        dayCell.appendChild(statusBadge);
                    }
                }
                
                calendarGrid.appendChild(dayCell);
            }
        }

        // Open day detail panel
        async function openDayDetail(dateStr, dayData) {
            try {
                showLoadingDetail();
                dayDetailPanel.classList.add('open');
                
                let content = `<h3>${formatDate(dateStr)}</h3>`;
                
                if (dayData && dayData.workout_id) {
                    // Fetch detailed workout info
                    const response = await fetch(`${API_BASE}/api/v1/calendar/${ATHLETE_ID}/workout/${dayData.workout_id}`);
                    const workoutData = await response.json();
                    
                    if (workoutData.success) {
                        const workout = workoutData.workout;
                        
                        content += `
                            <div class="workout-detail">
                                <h4>${workout.workout_type.replace('_', ' ').toUpperCase()}</h4>
                                <p>${workout.description || 'No description'}</p>
                                <div style="margin: 1rem 0;">
                                    <div><strong>Duration:</strong> ${workout.duration_minutes} minutes</div>
                                    <div><strong>Target TSS:</strong> ${workout.target_tss}</div>
                                    <div><strong>Environment:</strong> ${workout.environment}</div>
                                    <div><strong>Status:</strong> ${workout.completion_status || 'scheduled'}</div>
                                </div>
                                
                                <div class="file-downloads">
                                    <button class="btn btn-secondary" onclick="downloadFile(${workout.id}, 'zwo')">
                                        Download .ZWO (Zwift)
                                    </button>
                                    <button class="btn btn-secondary" onclick="downloadFile(${workout.id}, 'fit')">
                                        Download .FIT (Garmin)
                                    </button>
                                </div>
                                
                                <div style="margin-top: 1rem;">
                                    <label><strong>Environment:</strong></label>
                                    <select id="environment-select" onchange="updateEnvironment(${workout.id}, this.value)" style="margin-left: 0.5rem;">
                                        <option value="indoor" ${workout.environment === 'indoor' ? 'selected' : ''}>Indoor</option>
                                        <option value="outdoor" ${workout.environment === 'outdoor' ? 'selected' : ''}>Outdoor</option>
                                    </select>
                                </div>
                            </div>
                        `;
                        
                        // Feedback section
                        content += `
                            <div class="feedback-section">
                                <h4>Workout Feedback</h4>
                                <div style="margin: 1rem 0;">
                                    <label>Rate of Perceived Exertion (RPE 1-10):</label>
                                    <input type="range" id="rpe-slider" min="1" max="10" value="${workout.athlete_feedback_rpe || 5}" class="rpe-slider">
                                    <div class="rpe-labels">
                                        <span>1 (Very Easy)</span>
                                        <span>10 (Max Effort)</span>
                                    </div>
                                </div>
                                
                                <div style="margin: 1rem 0;">
                                    <label>Notes:</label>
                                    <textarea id="feedback-notes" rows="3" style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 4px;">${workout.athlete_feedback_notes || ''}</textarea>
                                </div>
                                
                                <button class="btn" onclick="submitFeedback(${workout.id})">Submit Feedback</button>
                            </div>
                        `;
                    }
                } else {
                    content += `<p>No workout scheduled for this day.</p>`;
                }
                
                dayDetailContent.innerHTML = content;
            } catch (error) {
                dayDetailContent.innerHTML = `<div class="error">Error loading day details: ${error.message}</div>`;
            }
        }

        // Close detail panel
        function closeDetailPanel() {
            dayDetailPanel.classList.remove('open');
        }

        // Download workout file - USE YOUR EXISTING n8n WEBHOOK
        function downloadFile(workoutId, fileType) {
            // Use your existing n8n webhook for file downloads
            const webhookUrl = `https://dabosch.fit/webhook/workout-download?workout_id=${workoutId}&format=${fileType}`;
            window.open(webhookUrl, '_blank');
        }

        // Update workout environment
        async function updateEnvironment(workoutId, environment) {
            try {
                const response = await fetch(`${API_BASE}/api/v1/calendar/${ATHLETE_ID}/workout/${workoutId}`, {
                    method: 'PATCH',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ environment: environment })
                });
                
                const data = await response.json();
                if (data.success) {
                    alert('Environment updated successfully');
                    refreshCalendar();
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        // Submit feedback
        async function submitFeedback(workoutId) {
            const rpe = document.getElementById('rpe-slider').value;
            const notes = document.getElementById('feedback-notes').value;
            
            try {
                const response = await fetch(`${API_BASE}/api/v1/calendar/${ATHLETE_ID}/workout/${workoutId}`, {
                    method: 'PATCH',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({athlete_feedback_rpe: parseInt(rpe),
                        athlete_feedback_notes: notes
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    alert('Feedback submitted successfully!');
                    closeDetailPanel();
                    refreshCalendar();
                }
            } catch (error) {
                alert(`Error submitting feedback: ${error.message}`);
            }
        }

        // Navigation functions
        function previousMonth() {
            currentMonth--;
            if (currentMonth < 1) {
                currentMonth = 12;
                currentYear--;
            }
            loadCalendar(currentYear, currentMonth);
        }

        function nextMonth() {
            currentMonth++;
            if (currentMonth > 12) {
                currentMonth = 1;
                currentYear++;
            }
            loadCalendar(currentYear, currentMonth);
        }

        function showToday() {
            currentDate = new Date();
            currentYear = currentDate.getFullYear();
            currentMonth = currentDate.getMonth() + 1;
            loadCalendar(currentYear, currentMonth);
        }

        function refreshCalendar() {
            loadCalendar(currentYear, currentMonth);
        }

        // Helper functions
        function showLoading() {
            calendarGrid.innerHTML = '<div class="loading">Loading calendar...</div>';
        }

        function showLoadingDetail() {
            dayDetailContent.innerHTML = '<div class="loading">Loading details...</div>';
        }

        function showError(message) {
            calendarGrid.innerHTML = `<div class="error">${message}</div>`;
        }

        function getMonthName(month) {
            const months = [
                'January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'
            ];
            return months[month - 1];
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        }

        // Mark workout as completed
        async function markAsCompleted(workoutId) {
            try {
                const response = await fetch(`${API_BASE}/api/v1/calendar/${ATHLETE_ID}/workout/${workoutId}`, {
                    method: 'PATCH',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ completion_status: 'completed' })
                });
                
                const data = await response.json();
                if (data.success) {
                    alert('Workout marked as completed!');
                    closeDetailPanel();
                    refreshCalendar();
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        // Mark workout as skipped
        async function markAsSkipped(workoutId) {
            try {
                const response = await fetch(`${API_BASE}/api/v1/calendar/${ATHLETE_ID}/workout/${workoutId}`, {
                    method: 'PATCH',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ completion_status: 'skipped' })
                });
                
                const data = await response.json();
                if (data.success) {
                    alert('Workout marked as skipped');
                    closeDetailPanel();
                    refreshCalendar();
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        // Log coaching event (for debugging)
        async function logEvent(eventType, details) {
            try {
                await fetch(`${API_BASE}/api/v1/events`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        athlete_id: ATHLETE_ID,
                        event_type: eventType,
                        trigger: 'calendar_ui',
                        decision: details.decision || '',
                        rationale: details.rationale || '',
                        metadata: details.metadata || {}
                    })
                });
            } catch (error) {
                console.error('Failed to log event:', error);
            }
        }

        // Initialize on load
        window.addEventListener('load', () => {
            // Add click outside to close panel
            document.addEventListener('click', (e) => {
                if (!dayDetailPanel.contains(e.target) && 
                    !e.target.closest('.day-cell') && 
                    dayDetailPanel.classList.contains('open')) {
                    closeDetailPanel();
                }
            });
            
            // Escape key to close panel
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && dayDetailPanel.classList.contains('open')) {
                    closeDetailPanel();
                }
            });
        });
    </script>
</body>
</html>
