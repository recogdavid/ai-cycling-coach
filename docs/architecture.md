# Architecture Overview

## System Design

AI Cycling Coach uses a workflow-driven architecture centered around n8n for orchestration.

## Core Components

### 1. n8n Workflows

**Strava Integration:**
- OAuth2 authentication flow
- Token refresh (runs every hour)
- Activity webhook handling
- Ride data normalization

**AI Coaching:**
- Generate Training Plan - Creates week-long structured plans
- Ride Feedback Generator - Analyzes completed activities
- FTP Analysis - Recommends FTP updates

### 2. Database (PostgreSQL)

**Schema:**
```
athletes
├── Profile data (FTP, weight, goals)
├── Strava tokens (encrypted)
└── Training preferences

rides
├── Completed activity data
└── Links to Strava activities

ai_feedback
└── Coaching insights per ride

training_plans
├── Multi-week plan metadata
└── Generated by AI

planned_workouts
├── Individual prescribed workouts
├── Interval structures (JSONB)
└── Links to completed rides (when executed)

athlete_ftp_suggestions
└── Automated FTP recommendations
```

### 3. AI Layer (Ollama + Mistral)

**Local inference** - runs on host OS, not in Docker
- Model: Mistral 7B Q4_K_M (~4.4GB)
- API: HTTP on port 11434
- No external dependencies or costs

**Prompt Engineering:**
- Structured JSON output for parseable plans
- Context includes athlete FTP, goals, constraints
- Emphasizes training science principles

### 4. Infrastructure
```
nginx (reverse proxy)
    ↓
n8n workflows
    ↓
PostgreSQL ← stores data
    ↓
Ollama API ← local AI
```

## Data Flow: Training Plan Generation
```
1. User triggers webhook → /webhook/generate-plan

2. Fetch athlete data from DB
   - FTP, goals, weekly_hours_available, unavailable_days

3. Build AI prompt
   - Include athlete context
   - Specify JSON output format
   - Request 7-day structured plan

4. Call Ollama API (~90 seconds)
   - Mistral generates training plan
   - Returns JSON with workouts array

5. Parse AI response
   - Extract plan_summary
   - Extract workouts with intervals

6. Save to database
   - INSERT training_plans record
   - INSERT 7 planned_workouts records
   - Store interval data as JSONB

7. Respond to webhook
   - Return success + plan_id
```

## Security Model

- **HTTPS**: Automatic via Let's Encrypt
- **Authentication**: n8n protected by Basic Auth
- **Secrets**: Stored in .env (not committed)
- **Strava tokens**: Encrypted in database
- **Privacy**: All AI processing local (no data leaves server)

## Scalability Considerations

**Current limitations:**
- Single-user prototype
- Sequential AI processing (no queuing)
- One Ollama instance

**For multi-user:**
- Would need job queue (Redis + Bull)
- Multiple Ollama instances (load balancing)
- User authentication system
- Database connection pooling

## Technology Choices

**Why n8n?**
- Visual workflow editor
- Built-in Postgres/HTTP nodes
- Webhook support
- Easier than writing custom API

**Why Ollama?**
- Local inference (privacy)
- No API costs
- Good performance with Mistral
- Simple HTTP API

**Why Mistral 7B?**
- Good balance of size vs capability
- Fits on modest hardware (12GB RAM)
- Strong at structured output
- Open source

## Future Architecture Changes

**Planned:**
- Export FIT/ZWO files (Python library integration)
- Web UI (React + Next.js)
- User authentication (n8n + JWT or separate auth service)
- Workout matching algorithm (compare planned vs actual)

**Under consideration:**
- Switch from n8n to custom API (more control)
- Add caching layer (Redis)
- Event sourcing for plan adaptations
